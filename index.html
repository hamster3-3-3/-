<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>壽司飯感官評測系統</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f8fafc; }
    .score-btn {
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
      background-color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 4rem;
      line-height: 1.4;
    }
    .score-btn.active {
      background-color: #f97316;
      color: white;
      border-color: #ea580c;
      box-shadow: 0 4px 6px -1px rgba(234, 88, 12, 0.2);
    }
    .tab-btn {
      padding: 1.25rem 2rem;
      font-weight: 700;
      transition: all 0.3s;
      border-bottom: 4px solid transparent;
      color: #64748b;
    }
    .tab-btn.active {
      color: #f97316;
      border-bottom-color: #f97316;
      background-color: white;
    }
  </style>
</head>
<body class="p-4 md:p-8">
  <div class="max-w-4xl mx-auto">
    <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 flex flex-col md:flex-row justify-between items-center border-t-4 border-orange-500">
      <h1 class="text-2xl font-black text-slate-800">壽司飯感官評測系統</h1>
      <div class="mt-4 md:mt-0 flex flex-col items-end gap-3">
        <input
          type="text"
          id="assessorName"
          placeholder="填寫評測者姓名"
          class="border-b border-slate-300 p-2 focus:border-orange-500 outline-none text-right w-48 bg-transparent"
        />
        <button
          onclick="exportCSV()"
          class="bg-slate-800 text-white px-6 py-2 rounded-lg font-bold hover:bg-slate-900 transition text-sm"
        >
          匯出數據報表 (CSV)
        </button>
      </div>
    </div>

    <div class="flex bg-slate-100 rounded-t-xl overflow-hidden shadow-inner">
      <button onclick="switchCategory('細卷')" id="tab-細卷" class="tab-btn flex-1 active">細卷系列</button>
      <button onclick="switchCategory('脆卷')" id="tab-脆卷" class="tab-btn flex-1">脆卷系列</button>
      <button onclick="switchCategory('手卷')" id="tab-手卷" class="tab-btn flex-1">手卷系列</button>
    </div>

    <div class="bg-white rounded-b-xl shadow-lg border border-slate-200 overflow-hidden">
      <div class="bg-orange-50 p-6 border-b border-orange-100 flex items-center gap-4 justify-center">
        <label class="text-orange-900 font-bold text-lg">樣品編號：</label>
        <select
          id="idSelector"
          onchange="switchId(this.value)"
          class="bg-white border-2 border-orange-300 rounded-xl px-6 py-2 font-bold text-xl text-orange-700 outline-none w-64"
        ></select>
      </div>
      <div id="formContent" class="p-6 md:p-8 space-y-10"></div>
    </div>
  </div>

  <script>
    // ====== Google Drive 上傳（Apps Script Web App）設定 ======
    // 你已取得的 Web App URL（可直接用）
    const GAS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbzVRvmj_5E0Z4bmQ7VwAS5hJVqYXMY6ojkPhQw5d-C2llqCeeyqh6xU_jaUMbTqYMXTXA/exec";
    // 建議你在 Apps Script 端設一組 token，這裡需一致；若 Apps Script 沒做 token 檢查，可先留空字串
    const UPLOAD_TOKEN = "";
    // 你已確認 fetch 會遇到 CORS（TypeError: Failed to fetch / CORS policy），因此預設直接走「表單 POST」路徑
    // 若未來你把頁面放到同網域後端或取得可用的 CORS 回應，再把它改成 false 以優先使用 fetch 讀回 JSON。
    const FORCE_FORM_POST = true;

    // ====== 表單配置 ======
    const sampleIds = ['A(D+1)', 'A(D+2)', 'B(D+1)', 'B(D+2)'];
    const categories = ['細卷', '脆卷', '手卷'];
    const config = {
      '細卷': [...sampleIds],
      '脆卷': [...sampleIds],
      '手卷': [...sampleIds]
    };

    const scoreMapping = {
      appearance: { 1: 0, 2: 10, 3: 20, 4: 10 },
      texture: { 1: 0, 2: 20, 3: 40, 4: 20, 5: 0 },
      staling: { 1: 40, 2: 30, 3: 20, 4: 10 }
    };

    let allData = {};
    categories.forEach((c) => sampleIds.forEach((id) => {
      allData[`${c}_${id}`] = { category: c, id, appearance: null, texture: null, staling: null, comment: '' };
    }));

    let currentCategory = '細卷';
    let currentId = 'A(D+1)';

    function switchCategory(cat) {
      currentCategory = cat;
      document.querySelectorAll('.tab-btn').forEach((b) => b.classList.remove('active'));
      const tab = document.getElementById(`tab-${cat}`);
      if (tab) tab.classList.add('active');

      const selector = document.getElementById('idSelector');
      selector.innerHTML = (config[cat] || []).map((id) => `<option value="${escapeHtmlAttr(id)}">${escapeHtmlText(id)}</option>`).join('');
      switchId((config[cat] || [])[0] || '');
    }

    function switchId(id) {
      if (!id) return;
      currentId = id;
      document.getElementById('idSelector').value = id;
      renderForm();
    }

    function renderScoreButtons(field, options) {
      const key = `${currentCategory}_${currentId}`;
      const currentVal = allData[key][field];
      return options.map((opt) => `
        <button
          type="button"
          onclick="setScore('${field}', ${opt.v})"
          class="score-btn p-3 rounded-xl text-sm font-bold ${currentVal === opt.v ? 'active' : ''}"
        >
          ${escapeHtmlText(opt.t)}
        </button>
      `).join('');
    }

    function renderForm() {
      const key = `${currentCategory}_${currentId}`;
      const d = allData[key];

      document.getElementById('formContent').innerHTML = `
        <div class='grid grid-cols-1 lg:grid-cols-3 gap-12'>
          <div class='lg:col-span-2 space-y-10'>
            <section>
              <h3 class='font-bold mb-4'>外觀</h3>
              <div class='grid grid-cols-2 gap-4'>
                ${renderScoreButtons('appearance', [
                  { v: 1, t: '飯粒不完整、光澤不均勻' },
                  { v: 2, t: '飯粒不完整、光澤均勻' },
                  { v: 3, t: '飯粒完整、光澤均勻' },
                  { v: 4, t: '飯粒完整、光澤不均勻' }
                ])}
              </div>
            </section>

            <section>
              <h3 class='font-bold mb-4'>口感</h3>
              <div class='grid grid-cols-5 gap-3'>
                ${renderScoreButtons('texture', [
                  { v: 1, t: '極硬' },
                  { v: 2, t: '偏硬' },
                  { v: 3, t: '軟硬適中' },
                  { v: 4, t: '偏軟爛' },
                  { v: 5, t: '極軟爛' }
                ])}
              </div>
            </section>

            <section>
              <h3 class='font-bold mb-4'>老化</h3>
              <div class='grid grid-cols-4 gap-3'>
                ${renderScoreButtons('staling', [
                  { v: 1, t: '完全無老化' },
                  { v: 2, t: '些許老化' },
                  { v: 3, t: '大部分老化' },
                  { v: 4, t: '完全老化' }
                ])}
              </div>
            </section>
          </div>

          <div class='bg-slate-50 p-6 rounded-2xl border border-slate-200'>
            <h3 class='font-bold mb-3'>綜合感官評語</h3>
            <textarea
              oninput="updateComment(this.value)"
              class='w-full h-64 border p-3 rounded bg-white'
              placeholder='描述飯粒黏性、風味、平衡度等...'
            >${escapeHtmlText(d.comment || '')}</textarea>
          </div>
        </div>
      `;
    }

    function setScore(field, val) {
      const key = `${currentCategory}_${currentId}`;
      allData[key][field] = val;
      renderForm();
    }

    function updateComment(val) {
      const key = `${currentCategory}_${currentId}`;
      allData[key].comment = val;
    }

    // ====== CSV 生成 + 下載 + 上傳 ======
    function blobToDataURL(blob) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onloadend = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(blob); // data:text/csv;base64,....
      });
    }

    // ====== 上傳（避免 CORS）：優先 fetch；若遇到 CORS/Failed to fetch 則改用隱藏表單 POST ======
    function postViaHiddenForm(payload) {
      return new Promise((resolve, reject) => {
        try {
          // 建立/重用 iframe（用來接收提交，避免跳頁）
          let iframe = document.getElementById('uploadFrame');
          if (!iframe) {
            iframe = document.createElement('iframe');
            iframe.id = 'uploadFrame';
            iframe.name = 'uploadFrame';
            iframe.style.display = 'none';
            document.body.appendChild(iframe);
          }

          // 建立 form
          const form = document.createElement('form');
          form.style.display = 'none';
          form.method = 'POST';
          form.action = GAS_WEBAPP_URL;
          form.target = 'uploadFrame';

          // 以 x-www-form-urlencoded 送出（不受 CORS 讀取限制）
          // Apps Script 端建議 doPost 同時支援 JSON 與 e.parameter。
          ['token', 'filename', 'base64'].forEach((k) => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = k;
            input.value = payload[k] ?? '';
            form.appendChild(input);
          });

          document.body.appendChild(form);

          // 跨網域無法可靠讀回 JSON；以「送出後短暫等待」視為完成請求
          const timer = setTimeout(() => {
            cleanup();
            resolve({ ok: true, fileName: payload.filename, via: 'hidden-form', note: 'request-sent' });
          }, 1200);

          function cleanup() {
            clearTimeout(timer);
            form.remove();
          }

          form.submit();
        } catch (e) {
          reject(e);
        }
      });
    }

    async function uploadToDrive(blob, filename) {
      const dataUrl = await blobToDataURL(blob);

      const payload = {
        token: UPLOAD_TOKEN,
        filename,
        base64: dataUrl
      };

      // 你已選擇：只要「送出上傳請求」就視為成功。
      // 因為瀏覽器 CORS 限制，跨網域通常無法可靠讀回 Apps Script 的 JSON 回應。
      // 因此預設直接走 hidden-form（不受 CORS 讀取限制），並回傳 via='hidden-form'。
      if (FORCE_FORM_POST) {
        return await postViaHiddenForm(payload);
      }

      // 若未來環境允許 CORS（或同源），可用 fetch 讀回 JSON
      try {
        const res = await fetch(GAS_WEBAPP_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let json = null;
        try { json = JSON.parse(text); } catch (_) { /* ignore */ }

        if (!res.ok) throw new Error((json && json.message) || text || 'Upload failed');
        if (json && json.ok === false) throw new Error(json.message || 'Upload failed');

        return json || { ok: true, raw: text, via: 'fetch' };
      } catch (err) {
        return await postViaHiddenForm(payload);
      }
    }

    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const day = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${day}`;
    }

    function escapeCsvCell(value) {
      const s = String(value ?? '');
      return `"${s.replace(/"/g, '""')}"`;
    }

    async function exportCSV() {
      const name = (document.getElementById('assessorName').value || '').trim() || '未具名';

      // 用 \uFEFF（BOM）避免 Excel 開啟中文亂碼；用 \n 明確換行，避免語法錯誤
      let csv = "\uFEFF分類,樣品編號,評測者,外觀得分,口感得分,老化得分,總分,備註\n";

      Object.values(allData).forEach((d) => {
        const hasAny = Boolean(d.appearance || d.texture || d.staling || (d.comment && d.comment.trim() !== ''));
        if (!hasAny) return;

        const a = scoreMapping.appearance[d.appearance] || 0;
        const t = scoreMapping.texture[d.texture] || 0;
        const s = scoreMapping.staling[d.staling] || 0;
        const total = a + t + s;

        csv += [
          escapeCsvCell(d.category),
          escapeCsvCell(d.id),
          escapeCsvCell(name),
          escapeCsvCell(a),
          escapeCsvCell(t),
          escapeCsvCell(s),
          escapeCsvCell(total),
          escapeCsvCell(d.comment || '')
        ].join(',') + "\n";
      });

      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const filename = `壽司評測_${name}_${todayISO()}.csv`;

      // 1) 下載
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = filename;
      link.click();

      // 2) 上傳（若 Apps Script 未部署 doPost 或權限未正確，會失敗）
      try {
        const result = await uploadToDrive(blob, filename);

        // option 1：不追求回傳 fileId，只要送出即算成功
        if (result && result.via === 'hidden-form') {
          alert(
            `已送出上傳請求（不受 CORS 影響）。
` +
            `檔名：${filename}
` +
            `請到 Google Drive 確認是否已新增檔案。`
          );
        } else {
          const shownName = (result && result.fileName) ? result.fileName : filename;
          alert(`已完成上傳（可讀回回應）。
檔名：${shownName}`);
        }
      } catch (e) {
        alert(`上傳失敗：${(e && e.message) ? e.message : '請確認 Apps Script doPost/部署權限/URL 正確'}`);
      }
    }

    // ====== 簡易自我測試（不影響功能；僅 console） ======
    function assert(name, cond) {
      if (!cond) throw new Error(`Test failed: ${name}`);
      console.log(`✔ ${name}`);
    }

    function runSelfTests() {
      // Test 1: todayISO format
      assert('todayISO() 格式為 YYYY-MM-DD', /^\d{4}-\d{2}-\d{2}$/.test(todayISO()));

      // Test 2: scoreMapping total bounds
      const maxTotal = 20 + 40 + 40; // appearance max 20, texture max 40, staling max 40
      assert('最大總分應為 100', maxTotal === 100);

      // Test 3: CSV header contains BOM and newline
      let header = "\uFEFF分類,樣品編號,評測者,外觀得分,口感得分,老化得分,總分,備註\n";
      assert('CSV header 以 BOM 開頭', header.charCodeAt(0) === 0xFEFF);
      assert('CSV header 以換行結尾', header.endsWith('\n'));

      // Test 4: CSV row escaping
      const cell = escapeCsvCell('a"b');
      assert('CSV cell 雙引號轉義', cell === '"a""b"');
    }

    function escapeHtmlText(s) {
      return String(s ?? '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
    }

    function escapeHtmlAttr(s) {
      // attribute 也用同一套即可
      return escapeHtmlText(s);
    }

    window.onload = () => {
      runSelfTests();
      switchCategory('細卷');
    };
  </script>
</body>
</html>
