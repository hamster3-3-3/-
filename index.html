<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>訪廠問題表格｜填寫＋PPT 匯出</title>

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;600;700&display=swap');
    :root { --font: 'Noto Sans TC','Microsoft JhengHei',system-ui,-apple-system,Segoe UI,Arial,sans-serif; }
    body { font-family: var(--font); }

    /* 單張圖片：不縮放顯示（可捲動） */
    .one-image-wrap { overflow: auto; }
    .one-image-wrap img { max-width: none; height: auto; }

    /* Tabs scroll (mobile-friendly) */
    .tabs-scroll { -webkit-overflow-scrolling: touch; }
  </style>

  <script>
    // --- Robust loader for PptxGenJS (fix "download button does nothing" when CDN is blocked) ---
    async function loadScriptOnce(src) {
      return new Promise((resolve, reject) => {
        const existing = document.querySelector('script[data-src="' + src + '"]');
        if (existing) { resolve(); return; }

        const s = document.createElement('script');
        s.src = src;
        s.async = true;
        s.setAttribute('data-src', src);
        s.onload = () => resolve();
        s.onerror = () => reject(new Error('Failed to load: ' + src));
        document.head.appendChild(s);
      });
    }

    async function ensurePptxGenLoaded() {
      // Already loaded
      if (window.PptxGenJS) return true;

      const candidates = [
        // Primary (jsDelivr GitHub)
        'https://cdn.jsdelivr.net/gh/gitbrent/pptxgenjs@3.12.0/dist/pptxgen.bundle.js',
        // Fallback (unpkg)
        'https://unpkg.com/pptxgenjs@3.12.0/dist/pptxgen.bundle.js',
        // Local fallback (place pptxgen.bundle.js next to this HTML if you want offline mode)
        './pptxgen.bundle.js'
      ];

      for (const url of candidates) {
        try {
          await loadScriptOnce(url);
          if (window.PptxGenJS) return true;
        } catch (e) {
          // continue
          console.warn(e);
        }
      }
      return false;
    }
  </script>

  <script>
    // --- PDF.js loader (for extracting product name from 排關圖 PDF) ---
    async function ensurePdfJsLoaded() {
      if (window.pdfjsLib) return true;

      const candidates = [
        'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.min.js',
        'https://cdn.jsdelivr.net/npm/pdfjs-dist@4.10.38/build/pdf.min.js',
        './pdf.min.js'
      ];

      for (const url of candidates) {
        try {
          await loadScriptOnce(url);
          if (window.pdfjsLib) {
            // Worker (best effort)
            try {
              window.pdfjsLib.GlobalWorkerOptions.workerSrc =
                'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.10.38/pdf.worker.min.js';
            } catch (e) {}
            return true;
          }
        } catch (e) {
          console.warn(e);
        }
      }
      return false;
    }
  </script>

</head>

<body class="bg-slate-50 text-slate-800">
  <!-- Floating catalog button (left-top, slightly lower to avoid covering title) -->
  <button id="catalogBtn"
          class="fixed z-40 rounded-xl border bg-white/90 backdrop-blur px-3 py-2 text-sm font-semibold shadow hover:bg-slate-50" style="left: 0; top: 0;">
    商品目錄
  </button>

  <header class="sticky top-0 z-30 border-b bg-white/80 backdrop-blur">
    <div class="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between gap-3">
      <div class="min-w-0 flex items-center gap-2">
        <h1 class="text-lg font-bold truncate">訪廠問題表格</h1>
      </div>
      <div class="flex items-center gap-2">
        <button id="importPdfBtnHeader" class="rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">匯入排關圖</button>
        <button id="exportBtn"
                class="rounded-xl bg-orange-500 px-3 py-2 text-sm font-semibold text-white hover:bg-orange-400">
          下載 PPT
        </button>
      </div>
    </div>
  </header>

  <!-- Tabs bar -->
  <div id="tabsBar" class="sticky top-[57px] z-20 border-b bg-white">
    <div class="mx-auto max-w-6xl px-4 py-2">
      <div class="flex items-center gap-2">
        <div id="tabs" class="tabs-scroll flex-1 overflow-auto whitespace-nowrap"></div>
        <div class="shrink-0 hidden sm:flex items-center gap-2">
          <!-- 新增表單：放在「複製目前」左邊 -->
<button id="addRowBtn"
                  class="rounded-xl bg-slate-900 px-3 py-1.5 text-xs font-semibold text-white hover:bg-slate-800">
            新增表單
          </button>
          <button id="dupActiveBtn" class="rounded-xl border px-3 py-1.5 text-xs font-semibold hover:bg-slate-50">複製目前</button>
          <button id="delActiveBtn"
                  class="rounded-xl border border-rose-200 bg-rose-50 px-3 py-1.5 text-xs font-semibold text-rose-700 hover:bg-rose-100">
            刪除目前
          </button>
        </div>
      </div>
    </div>
  </div>

  <main class="mx-auto max-w-6xl px-4 py-6">
    <section aria-label="records">
      <div id="panels"></div>
    </section>
  </main>

  <!-- Catalog modal -->
  <div id="catalogModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" data-close="true"></div>
    <div class="absolute bottom-0 left-0 right-0 sm:inset-0 sm:flex sm:items-center sm:justify-center">
      <div class="w-full sm:max-w-lg rounded-t-2xl sm:rounded-2xl bg-white shadow-xl">
        <div class="flex items-center justify-between px-4 py-3 border-b">
          <div>
            <div class="text-sm font-semibold">商品目錄</div>
            <div class="text-xs text-slate-500">點選可跳轉到對應表單</div>
          </div>
          <button id="closeCatalogBtn" class="rounded-xl border px-3 py-1.5 text-xs font-semibold hover:bg-slate-50">關閉</button>
        </div>
        <div id="catalogList" class="max-h-[70vh] overflow-auto p-2"></div>
      </div>
    </div>
  </div>

  <template id="panelTpl">
    <article class="rounded-2xl border bg-white p-4 shadow-sm">
      <div class="flex items-start justify-between gap-3">
        <div class="min-w-0">
          <h2 class="text-sm font-semibold text-slate-700">
            <span class="panelTitle">表單</span>
          </h2>
        </div>
        <!-- Mobile actions (same position on every form) -->
        <div class="flex shrink-0 items-center gap-2 sm:hidden">
          <button class="addBtn rounded-xl border px-3 py-1.5 text-xs font-semibold hover:bg-slate-50">新增</button>
          <button class="dupBtn rounded-xl border px-3 py-1.5 text-xs font-semibold hover:bg-slate-50">複製</button>
          <button class="delBtn rounded-xl border border-rose-200 bg-rose-50 px-3 py-1.5 text-xs font-semibold text-rose-700 hover:bg-rose-100">刪除</button>
        </div>
      </div>

      <div class="mt-4 grid grid-cols-1 gap-4 md:grid-cols-12">
        <label class="md:col-span-4">
          <span class="text-xs font-semibold text-slate-600">類型</span>
          <select class="typeInput mt-1 w-full rounded-xl border px-3 py-2 text-sm focus:outline-none focus:ring">
            <option value="">請選擇</option>
            <option value="生產面">生產面</option>
            <option value="衛生面">衛生面</option>
          </select>
        </label>

        <label class="md:col-span-8">
          <span class="text-xs font-semibold text-slate-600">商品名</span>
          <div class="mt-1 flex items-center gap-2">
            <input class="nameInput flex-1 w-full rounded-xl border px-3 py-2 text-sm focus:outline-none focus:ring" placeholder="" />
            <button type="button" class="showPdfBtn shrink-0 rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-slate-50">
              顯示排關圖
            </button>
          </div>
        </label>

        <label class="md:col-span-12">
          <span class="text-xs font-semibold text-slate-600">問題說明</span>
          <textarea class="descInput mt-1 w-full rounded-xl border px-3 py-2 text-sm focus:outline-none focus:ring" rows="6" placeholder=""></textarea>
        </label>
      </div>

      <div class="mt-4 rounded-2xl border bg-slate-50 p-4">
        <div class="flex flex-wrap items-center justify-between gap-3">
          <div>
            <p class="text-sm font-semibold">圖片上傳（支援手機、多張）</p>
            <p class="text-xs text-slate-600">一次可選多張；PPT 每頁最多放 2 張，超過會自動續頁。</p>
          </div>
          <div class="flex items-center gap-2">
            <label class="rounded-xl bg-slate-900 px-3 py-2 text-sm font-semibold text-white hover:bg-slate-800 cursor-pointer">
              選擇圖片
              <input class="imgInput hidden" type="file" accept="image/*" multiple />
            </label>
            <button class="clearImgsBtn rounded-xl border px-3 py-2 text-sm font-semibold hover:bg-white">清除圖片</button>
          </div>
        </div>

        <div class="mt-4">
          <div class="imgHint text-xs text-slate-500">尚未選擇圖片。</div>
          <div class="imgPreview mt-3"></div>
        </div>
      </div>
    </article>
  </template>

  <input id="pdfInput" type="file" accept="application/pdf" multiple class="hidden" />


  <script>
    const $ = (sel, root) => (root || document).querySelector(sel);
    const $$ = (sel, root) => Array.from((root || document).querySelectorAll(sel));

    const tabsEl = $('#tabs');
    const panelsEl = $('#panels');
    const panelTpl = $('#panelTpl');

    const state = { records: [], active: 0 };


    // ---------------- 排關圖（PDF）管理 ----------------
    const pdfStore = new Map(); // key: normalized product name -> { displayName, fileName, blobUrl }

    function normalizeKey(s) {
      const t = (s || '').toString().trim();
      return t
        .replace(/\s+/g, '')
        .replace(/[()（）【】\[\]{}「」『』"“”'’`·•‧,，.。:：;；!！?？\/\\|｜\-—_]/g, '')
        .toLowerCase();
    }

    function guessNameFromFilename(fileName) {
      const base = (fileName || '').replace(/\.pdf$/i, '');
      // 例： "1.義式番茄起司義大利麵" -> "義式番茄起司義大利麵"
      return base.replace(/^\s*\d+\s*[\.\-、_ ]\s*/,'').trim() || base.trim();
    }

    async function extractProductNameFromPdf(arrayBuffer) {
      const ok = await ensurePdfJsLoaded();
      if (!ok || !window.pdfjsLib) return '';

      try {
        const doc = await window.pdfjsLib.getDocument({ data: arrayBuffer }).promise;
        const page = await doc.getPage(1);
        const tc = await page.getTextContent();
        const text = tc.items.map(it => (it && it.str) ? it.str : '').join(' ');
        // 常見格式： "商品名稱 義式番茄起司義大利麵"
        let m = text.match(/商品名稱\s*([^\s].*?)(?:\s{2,}|生產列數|半成品設備|包裝設備|作成日|產線時間|$)/);
        if (m && m[1]) return m[1].trim();

        const idx = text.indexOf('商品名稱');
        if (idx >= 0) {
          const tail = text.slice(idx + 4, idx + 60);
          return tail.trim();
        }
        return '';
      } catch (e) {
        console.warn('extractProductNameFromPdf failed', e);
        return '';
      }
    }

    function pdfListText() {
      const names = Array.from(pdfStore.values()).map(v => v.displayName).filter(Boolean);
      return names.length ? names.join('、') : '（無）';
    }

    async function importPdfFiles(files) {
      if (!files || !files.length) return;

      let imported = 0;

      for (const f of files) {
        try {
          const ab = await f.arrayBuffer();
          const extracted = await extractProductNameFromPdf(ab);
          const displayName = extracted || guessNameFromFilename(f.name);
          const key = normalizeKey(displayName);
          const blobUrl = URL.createObjectURL(new Blob([ab], { type: 'application/pdf' }));

          const prev = pdfStore.get(key);
          if (prev && prev.blobUrl) {
            try { URL.revokeObjectURL(prev.blobUrl); } catch (e) {}
          }

          pdfStore.set(key, { displayName, fileName: f.name, blobUrl });
          imported += 1;
        } catch (e) {
          console.warn('import pdf failed:', f && f.name, e);
        }
      }

      alert(`已匯入排關圖：${imported} 份`);
    }

    function findPdfForProductName(productName) {
      const key = normalizeKey(productName);
      if (!key) return null;

      if (pdfStore.has(key)) return pdfStore.get(key);

      for (const [k, v] of pdfStore.entries()) {
        if (k && key && (k.includes(key) || key.includes(k))) return v;
      }
      return null;
    }

    function openPdfModal(productName, pdfItem) {
      const modal = document.getElementById('pdfModal');
      const frame = document.getElementById('pdfFrame');
      const empty = document.getElementById('pdfEmpty');
      const title = document.getElementById('pdfTitle');
      const list = document.getElementById('pdfListText');

      title.textContent = productName ? `商品名：${productName}` : '—';
      list.textContent = pdfListText();

      if (pdfItem && pdfItem.blobUrl) {
        empty.classList.add('hidden');
        frame.classList.remove('hidden');
        frame.src = pdfItem.blobUrl;
      } else {
        frame.classList.add('hidden');
        frame.src = 'about:blank';
        empty.classList.remove('hidden');
      }

      modal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }

    function closePdfModal() {
      const modal = document.getElementById('pdfModal');
      const frame = document.getElementById('pdfFrame');
      modal.classList.add('hidden');
      try { frame.src = 'about:blank'; } catch (e) {}
      document.body.classList.remove('overflow-hidden');
    }


    function deepClone(obj) { return JSON.parse(JSON.stringify(obj)); }

    function todayISO() {
      const d = new Date();
      const pad = (n) => String(n).padStart(2, '0');
      return `${d.getFullYear()}-${pad(d.getMonth() + 1)}-${pad(d.getDate())}`;
    }

    function makeEmptyRecord() { return { type: '', name: '', desc: '', images: [] }; }

    function displayName(rec, idx) {
      const name = rec && typeof rec.name === 'string' ? rec.name : '';
      const n = name.trim();
      return n ? n : `未命名 ${idx + 1}`;
    }

    function chunk(arr, size) {
      const out = [];
      for (let i = 0; i < arr.length; i += size) out.push(arr.slice(i, i + size));
      return out;
    }

    function fileToDataUrl(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function getImageSize(dataUrl) {
      return new Promise((resolve) => {
        const img = new Image();
        img.onload = () => resolve({ width: img.naturalWidth, height: img.naturalHeight });
        img.src = dataUrl;
      });
    }

    function renderImagePreview(container, images) {
      container.innerHTML = '';
      if (!images || images.length === 0) return;

      if (images.length === 1) {
        const wrap = document.createElement('div');
        wrap.className = 'one-image-wrap rounded-xl border bg-white p-2';
        const img = document.createElement('img');
        img.src = images[0].dataUrl;
        img.alt = images[0].name || 'image';
        wrap.appendChild(img);
        container.appendChild(wrap);
        return;
      }

      const grid = document.createElement('div');
      grid.className = 'grid grid-cols-2 gap-3 sm:grid-cols-3 lg:grid-cols-4';
      images.forEach((it) => {
        const card = document.createElement('div');
        card.className = 'rounded-xl border bg-white p-2';

        const img = document.createElement('img');
        img.src = it.dataUrl;
        img.alt = it.name || 'image';
        img.className = 'h-32 w-full rounded-lg object-cover';

        const meta = document.createElement('div');
        meta.className = 'mt-2 text-[11px] text-slate-500 break-all';
        meta.textContent = it.name || '';

        card.appendChild(img);
        card.appendChild(meta);
        grid.appendChild(card);
      });
      container.appendChild(grid);
    }

    function setActive(index, opts) {
      const options = opts || { scrollTabIntoView: true };
      const i = Math.max(0, Math.min(index, state.records.length - 1));
      state.active = i;

      $$('.tabBtn', tabsEl).forEach((btn) => {
        const idx = Number(btn.dataset.idx);
        const isOn = idx === i;
        btn.classList.toggle('bg-slate-900', isOn);
        btn.classList.toggle('text-white', isOn);
        btn.classList.toggle('bg-white', !isOn);
        btn.classList.toggle('text-slate-700', !isOn);
        btn.classList.toggle('border-slate-200', !isOn);
        btn.classList.toggle('border-slate-900', isOn);
      });

      $$('.panel', panelsEl).forEach((p) => {
        const idx = Number(p.dataset.idx);
        p.classList.toggle('hidden', idx !== i);
      });

      if (options.scrollTabIntoView) {
        const activeBtn = tabsEl.querySelector(`.tabBtn[data-idx="${i}"]`);
        if (activeBtn) activeBtn.scrollIntoView({ behavior: 'smooth', inline: 'center', block: 'nearest' });
      }

      // Reposition floating catalog button after tab changes
      schedulePositionCatalogBtn();
    }

    function updateTabLabel(idx) {
      const el = tabsEl.querySelector(`.tabBtn[data-idx="${idx}"] .tabLabel`);
      if (el) el.textContent = displayName(state.records[idx], idx);
    }

    function updatePanelTitle(panelEl, idx) {
      const t = panelEl.querySelector('.panelTitle');
      if (t) t.textContent = displayName(state.records[idx], idx);
    }

    function removeAt(idx) {
      if (state.records.length <= 1) {
        state.records[0] = makeEmptyRecord();
        renderAll();
        schedulePositionCatalogBtn();
        return;
      }
      state.records.splice(idx, 1);
      if (state.active >= state.records.length) state.active = state.records.length - 1;
      renderAll();
    }

    function duplicateAt(idx) {
      const copy = deepClone(state.records[idx]);
      state.records.splice(idx + 1, 0, copy);
      renderAll();
      setActive(idx + 1);
    }

    function addForm(prefill) {
      const record = prefill ? deepClone(prefill) : makeEmptyRecord();
      state.records.push(record);
      renderAll();
      setActive(state.records.length - 1);
    }

    function renderAll() {
      tabsEl.innerHTML = '';
      panelsEl.innerHTML = '';

      state.records.forEach((rec, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.dataset.idx = String(idx);
        btn.className = 'tabBtn inline-flex items-center gap-2 rounded-xl border px-3 py-2 text-sm font-semibold mr-2';
        btn.innerHTML = `<span class="tabLabel">${displayName(rec, idx)}</span>`;
        btn.addEventListener('click', () => setActive(idx));
        tabsEl.appendChild(btn);

        const node = panelTpl.content.cloneNode(true);
        const panel = node.querySelector('article');
        panel.classList.add('panel');
        panel.dataset.idx = String(idx);

        const typeInput = $('.typeInput', panel);
        const nameInput = $('.nameInput', panel);
        const descInput = $('.descInput', panel);

        const imgInput = $('.imgInput', panel);
        const imgHint = $('.imgHint', panel);
        const imgPreview = $('.imgPreview', panel);

        typeInput.value = rec.type || '';
        nameInput.value = rec.name || '';
        descInput.value = rec.desc || '';

        updatePanelTitle(panel, idx);

        if (rec.images && rec.images.length) {
          imgHint.textContent = `已選擇 ${rec.images.length} 張圖片。`;
          renderImagePreview(imgPreview, rec.images);
        }

        const setRecord = (patch) => Object.assign(state.records[idx], patch);

        typeInput.addEventListener('change', (e) => setRecord({ type: e.target.value || '' }));

        nameInput.addEventListener('input', (e) => {
          setRecord({ name: e.target.value || '' });
          updateTabLabel(idx);
          updatePanelTitle(panel, idx);
        });

        descInput.addEventListener('input', (e) => setRecord({ desc: e.target.value || '' }));

        // 顯示排關圖
        const showPdfBtn = panel.querySelector('.showPdfBtn');
        if (showPdfBtn) {
          showPdfBtn.addEventListener('click', () => {
            const productName = (state.records[idx].name || '').trim();
            const pdfItem = findPdfForProductName(productName);
            openPdfModal(productName || displayName(state.records[idx], idx), pdfItem);
          });
        }


        imgInput.addEventListener('change', async (e) => {
          const files = Array.from((e.target && e.target.files) ? e.target.files : []);
          if (!files.length) return;

          const imgs = [];
          for (const f of files) {
            const dataUrl = await fileToDataUrl(f);
            const size = await getImageSize(dataUrl);
            imgs.push({ name: f.name, dataUrl, width: size.width, height: size.height });
          }

          const merged = (state.records[idx].images || []).concat(imgs);
          setRecord({ images: merged });

          imgHint.textContent = `已選擇 ${merged.length} 張圖片。`;
          renderImagePreview(imgPreview, merged);

          e.target.value = '';
        });

        $('.clearImgsBtn', panel).addEventListener('click', () => {
          setRecord({ images: [] });
          imgHint.textContent = '尚未選擇圖片。';
          imgPreview.innerHTML = '';
        });

        $('.addBtn', panel).addEventListener('click', () => addForm());
        $('.dupBtn', panel).addEventListener('click', () => duplicateAt(idx));
        $('.delBtn', panel).addEventListener('click', () => removeAt(idx));

        panelsEl.appendChild(node);
      });

      setActive(Math.min(state.active, state.records.length - 1), { scrollTabIntoView: false });

      // Keep floating catalog button aligned under tab row
      schedulePositionCatalogBtn();
    }

    // ---------------- PPTX Export: match template ----------------
    // NOTE: PptxGenJS is loaded dynamically on click to avoid "button no effect" when CDN fails.

    const TPL = {
      slideW: 10,
      slideH: 7.5,

      // Master decorations (from 公版：訪廠問題表格.pptx)
      decor: {
        // two stripes at top and bottom
        x: 0.1076389,
        w: 9.8263889,
        topGreenY: 0.4947922,
        topBlueY: 0.5420770,
        bottomGreenY: 7.2582707,
        bottomBlueY: 7.3055556,
        green: '008000',
        blue:  '3366FF',
        lineW: 2
      },

      footer: {
        text: '本文件為「全家便利商店股份有限公司」所有，請勿外洩',
        x: 3.4302592,
        y: 7.2586811,
        w: 4.0104167,
        h: 0.2690967,
        font: '標楷體',
        size: 10,
        color: '000000'
      },

      impl: {
        x: 7.9074059,
        y: 0.6485466,
        w: 1.9069543,
        h: 0.4882951,
        fill: 'FFF2CC',
        line: '2D4D6A',
        font: 'Microsoft JhengHei',
        size: 18,
        color: '000000',
        text: '實施日:'
      },

      title: { x: 0.128, y: 0.014, w: 9.785, h: 0.472, text: '一、調整說明', font: 'Meiryo UI', size: 18, color: '000000' },
      bar:   { x: 0.227, y: 0.695, w: 9.587, h: 0.442, fill: '2E75B6', textColor: 'FFFF00', font: 'Microsoft JhengHei', size: 18 },

      t1: {
        x: 0.277, y: 1.183, w: 9.488, h: 3.545,
        colW: 4.744, headH: 0.748, bodyH: 2.797,
        headFill: 'DEEAF7',
        border: '4A4E52',
        sep: '414243',
        headFont: 'Microsoft JhengHei',
        headSize: 16
      },

      t2: {
        x: 0.277, y: 4.728, w: 9.488, h: 2.478,
        colW: 4.744, rowH: 0.62,
        border: '000000',
        font: 'Microsoft JhengHei',
        size: 14
      },

      photoPad: 0.15
    };

    function formatExportError(err) {
      const msg = err && err.message ? err.message : String(err);
      return `PPT 匯出失敗：\n${msg}`;
    }

    function drawTemplate(slide, rec, pptx) {
      // Background (white) — use shape for maximum compatibility
      slide.addShape(pptx.ShapeType.rect, {
        x: 0, y: 0, w: TPL.slideW, h: TPL.slideH,
        fill: { color: 'FFFFFF' },
        line: { color: 'FFFFFF', width: 0 }
      });

      
      // Master top/bottom stripes (全家公版裝飾)
      slide.addShape(pptx.ShapeType.line, {
        x: TPL.decor.x, y: TPL.decor.topGreenY, w: TPL.decor.w, h: 0,
        line: { color: TPL.decor.green, width: TPL.decor.lineW }
      });
      slide.addShape(pptx.ShapeType.line, {
        x: TPL.decor.x, y: TPL.decor.topBlueY, w: TPL.decor.w, h: 0,
        line: { color: TPL.decor.blue, width: TPL.decor.lineW }
      });
      slide.addShape(pptx.ShapeType.line, {
        x: TPL.decor.x, y: TPL.decor.bottomGreenY, w: TPL.decor.w, h: 0,
        line: { color: TPL.decor.green, width: TPL.decor.lineW }
      });
      slide.addShape(pptx.ShapeType.line, {
        x: TPL.decor.x, y: TPL.decor.bottomBlueY, w: TPL.decor.w, h: 0,
        line: { color: TPL.decor.blue, width: TPL.decor.lineW }
      });

      // Footer disclaimer text (master)
      slide.addText(TPL.footer.text, {
        x: TPL.footer.x, y: TPL.footer.y, w: TPL.footer.w, h: TPL.footer.h,
        fontFace: TPL.footer.font, fontSize: TPL.footer.size,
        color: TPL.footer.color, align: 'center', valign: 'mid'
      });

      



slide.addText(TPL.title.text, {
        x: TPL.title.x, y: TPL.title.y, w: TPL.title.w, h: TPL.title.h,
        fontFace: TPL.title.font, fontSize: TPL.title.size, color: TPL.title.color,
        valign: 'mid', align: 'left'
      });

      slide.addShape(pptx.ShapeType.rect, {
        x: TPL.bar.x, y: TPL.bar.y, w: TPL.bar.w, h: TPL.bar.h,
        fill: { color: TPL.bar.fill }, line: { color: TPL.bar.fill, width: 0 }
      });

      const typeTxt = (rec.type || '【類型】').trim();
      const nameTxt = (rec.name || '【商品名】').trim();

      // Header text: 類型 = 黃色；商品名 = 白色（避免整段都黃）
      const headerRuns = [
        { text: typeTxt, options: { color: 'FFFF00', bold: true } },
        { text: '-',      options: { color: 'FFFFFF', bold: true } },
        { text: nameTxt,  options: { color: 'FFFFFF', bold: true } },
      ];

      // PptxGenJS v3 supports rich text runs (array). If not, fall back to two text boxes.
      try {
        slide.addText(headerRuns, {
          x: TPL.bar.x, y: TPL.bar.y, w: TPL.bar.w, h: TPL.bar.h,
          fontFace: TPL.bar.font, fontSize: TPL.bar.size,
          align: 'center', valign: 'mid'
        });
      } catch (e) {
        // Fallback: approximate centering by splitting the bar into two regions
        slide.addText(typeTxt, {
          x: TPL.bar.x, y: TPL.bar.y, w: TPL.bar.w * 0.35, h: TPL.bar.h,
          fontFace: TPL.bar.font, fontSize: TPL.bar.size, bold: true,
          color: 'FFFF00', align: 'right', valign: 'mid'
        });
        slide.addText('-' + nameTxt, {
          x: TPL.bar.x + TPL.bar.w * 0.35, y: TPL.bar.y, w: TPL.bar.w * 0.65, h: TPL.bar.h,
          fontFace: TPL.bar.font, fontSize: TPL.bar.size, bold: true,
          color: 'FFFFFF', align: 'left', valign: 'mid'
        });
      }
const t1 = TPL.t1;

      slide.addShape(pptx.ShapeType.rect, {
        x: t1.x, y: t1.y, w: t1.w, h: t1.h,
        fill: { color: 'FFFFFF', transparency: 100 },
        line: { color: t1.border, width: 1 }
      });

      slide.addShape(pptx.ShapeType.rect, {
        x: t1.x, y: t1.y, w: t1.colW, h: t1.headH,
        fill: { color: t1.headFill }, line: { color: t1.border, width: 1 }
      });
      slide.addShape(pptx.ShapeType.rect, {
        x: t1.x + t1.colW, y: t1.y, w: t1.colW, h: t1.headH,
        fill: { color: t1.headFill }, line: { color: t1.border, width: 1 }
      });

      slide.addShape(pptx.ShapeType.line, {
        x: t1.x + t1.colW, y: t1.y, w: 0, h: t1.h,
        line: { color: '000000', width: 1 }
      });

      slide.addShape(pptx.ShapeType.line, {
        x: t1.x, y: t1.y + t1.headH, w: t1.w, h: 0,
        line: { color: t1.sep, width: 1 }
      });

      slide.addText('改善前', {
        x: t1.x, y: t1.y, w: t1.colW, h: t1.headH,
        fontFace: t1.headFont, fontSize: t1.headSize, bold: true,
        color: '000000', align: 'center', valign: 'mid'
      });
      slide.addText('改善後', {
        x: t1.x + t1.colW, y: t1.y, w: t1.colW, h: t1.headH,
        fontFace: t1.headFont, fontSize: t1.headSize, bold: true,
        color: '000000', align: 'center', valign: 'mid'
      });

      const t2 = TPL.t2;

      slide.addShape(pptx.ShapeType.rect, {
        x: t2.x, y: t2.y, w: t2.w, h: t2.h,
        fill: { color: 'FFFFFF', transparency: 100 },
        line: { color: t2.border, width: 1 }
      });

      slide.addShape(pptx.ShapeType.line, {
        x: t2.x + t2.colW, y: t2.y, w: 0, h: t2.h,
        line: { color: t2.border, width: 1 }
      });

      // 橫線：只畫右側 PDCA 區（左側回答框不畫橫線）
      const rightX = t2.x + t2.colW;
      const rightW = t2.w - t2.colW;
      for (let i = 1; i <= 3; i++) {
        slide.addShape(pptx.ShapeType.line, {
          x: rightX,
          y: t2.y + t2.rowH * i,
          w: rightW,
          h: 0,
          line: { color: t2.border, width: 1 }
        });
      }

      // 左上標籤：只保留「P(問題)」，並稍微下移避免貼邊
      slide.addText('P(問題)', {
        x: t2.x + 0.10,
        y: t2.y + 0.06,
        w: t2.colW - 0.20,
        h: 0.35,
        fontFace: t2.font,
        fontSize: t2.size,
        color: '000000',
        align: 'left',
        valign: 'top'
      });

      const pdca = ['P：', 'D：', 'C：', 'A：'];
      pdca.forEach((lab, i) => {
        slide.addText(lab, {
          x: t2.x + t2.colW + 0.12, y: t2.y + t2.rowH * i,
          w: t2.colW - 0.24, h: t2.rowH,
          fontFace: t2.font, fontSize: t2.size, color: '000000',
          align: 'left', valign: 'mid'
        });
      });

      const desc = (rec.desc || '').trim();
      if (desc) {
        // 左側回答框：整塊空白區（無橫線），文字從標籤下方開始
        slide.addText(desc, {
          x: t2.x + 0.12,
          y: t2.y + 0.48,
          w: t2.colW - 0.24,
          h: t2.h - 0.60,
          fontFace: t2.font,
          fontSize: 12,
          color: '111111',
          align: 'left',
          valign: 'top'
        });
      }

      // 實施日（置頂顯示：確保在所有圖層最上方）
      // 實施日（表單不填寫；PPT 保留給對方填）
            slide.addShape(pptx.ShapeType.roundRect, {
              x: TPL.impl.x, y: TPL.impl.y, w: TPL.impl.w, h: TPL.impl.h,
              fill: { color: TPL.impl.fill },
              line: { color: TPL.impl.line, width: 1 }
            });
            slide.addText(TPL.impl.text, {
              x: TPL.impl.x + 0.10, y: TPL.impl.y, w: TPL.impl.w - 0.20, h: TPL.impl.h,
              fontFace: TPL.impl.font, fontSize: TPL.impl.size,
              color: TPL.impl.color, align: 'left', valign: 'mid'
            });

}

    function addPhotos(slide, pair) {
      if (!pair || (!pair[0] && !pair[1])) return;

      const t1 = TPL.t1;
      const bodyY = t1.y + t1.headH;
      const pad = TPL.photoPad;

      const leftBox  = { x: t1.x + pad,           y: bodyY + pad, w: t1.colW - pad * 2, h: t1.bodyH - pad * 2 };
      const rightBox = { x: t1.x + t1.colW + pad, y: bodyY + pad, w: t1.colW - pad * 2, h: t1.bodyH - pad * 2 };

      const put = (img, box) => {
        if (!img) return;
        slide.addImage({
          data: img.dataUrl,
          x: box.x, y: box.y, w: box.w, h: box.h,
          sizing: { type: 'contain', x: box.x, y: box.y, w: box.w, h: box.h }
        });
      };

      put(pair[0], leftBox);
      put(pair[1], rightBox);
    }

    async function exportPPT() {
      // Ensure library available; otherwise show actionable error
      const ok = await ensurePptxGenLoaded();
      if (!ok || !window.PptxGenJS) {
        alert('無法載入 PPT 匯出元件（PptxGenJS）。\n\n可能原因：網路環境封鎖 CDN 或離線。\n解法：\n1) 改用可連外的網路開啟此頁；或\n2) 下載 pptxgen.bundle.js 放在此 HTML 同一資料夾（離線模式）。');
        return;
      }

      if (!state.records.length) { alert('目前沒有資料可匯出。'); return; }

      const hasAny = state.records.some(r => (r.type || r.name || r.desc || (r.images && r.images.length)));
      if (!hasAny) { alert('資料皆為空白，請至少填寫一筆內容或上傳圖片。'); return; }

      let pptx;
      try {
        pptx = new window.PptxGenJS();
        pptx.layout = 'LAYOUT_4x3';
      } catch (e) {
        alert(formatExportError(e));
        return;
      }

      for (const rec of state.records) {
        const imgs = rec.images || [];
        const pages = imgs.length ? chunk(imgs, 2) : [ [] ];
        pages.forEach((pair) => {
          const slide = pptx.addSlide();
          drawTemplate(slide, rec, pptx);
          addPhotos(slide, pair);
        });
      }

      const fnDate = todayISO().split('-').join('');
      const filename = `訪廠問題表格_${fnDate}.pptx`;

      try {
        await pptx.writeFile({ fileName: filename });
      } catch (err) {
        console.error(err);
        alert(formatExportError(err));
      }
    }

    // ---------------- Catalog ----------------
    function openCatalog() {
      const modal = $('#catalogModal');
      const list = $('#catalogList');
      list.innerHTML = '';

      state.records.forEach((rec, idx) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-full text-left rounded-xl border px-3 py-3 hover:bg-slate-50 flex items-center justify-between gap-3';
        const name = displayName(rec, idx);
        const sub = (rec.type || '').trim();
        btn.innerHTML = `
          <div class="min-w-0">
            <div class="text-sm font-semibold truncate">${name}</div>
            <div class="text-xs text-slate-500 truncate">${sub ? sub : ''}</div>
          </div>
          <div class="text-xs text-slate-400 shrink-0">第 ${idx + 1} 筆</div>
        `;
        btn.addEventListener('click', () => {
          closeCatalog();
          setActive(idx);
          window.scrollTo({ top: 0, behavior: 'smooth' });
        });
        list.appendChild(btn);
      });

      modal.classList.remove('hidden');
      document.body.classList.add('overflow-hidden');
    }

    function closeCatalog() {
      const modal = $('#catalogModal');
      modal.classList.add('hidden');
      document.body.classList.remove('overflow-hidden');
    }

    
    function positionCatalogBtn() {
      const btn = document.getElementById('catalogBtn');
      const bar = document.getElementById('tabsBar');
      const tabs = document.getElementById('tabs');
      if (!btn || !bar || !tabs) return;

      const barRect = bar.getBoundingClientRect();
      const tabsRect = tabs.getBoundingClientRect();

      // Align to the left edge of the tab strip; place just below the tabs bar
      const left = Math.max(8, Math.round(tabsRect.left));
      const top = Math.round(barRect.bottom + 8);

      btn.style.left = left + 'px';
      btn.style.top = top + 'px';
    }

    let _posRaf = 0;
    function schedulePositionCatalogBtn() {
      if (_posRaf) return;
      _posRaf = requestAnimationFrame(() => {
        _posRaf = 0;
        positionCatalogBtn();
      });
    }

    // ---------------- Init ----------------
    $('#addRowBtn').addEventListener('click', () => addForm());
    $('#exportBtn').addEventListener('click', exportPPT);


    // PDF import buttons
    const pdfInputEl = document.getElementById('pdfInput');
    const hookImport = () => { if (pdfInputEl) pdfInputEl.click(); };

    const importBtnHeader = document.getElementById('importPdfBtnHeader');
    if (importBtnHeader) importBtnHeader.addEventListener('click', hookImport);

    if (pdfInputEl) {
      pdfInputEl.addEventListener('change', async (e) => {
        const files = Array.from((e.target && e.target.files) ? e.target.files : []);
        await importPdfFiles(files);
        e.target.value = '';
      });
    }

    // PDF modal close
    const closePdfBtn = document.getElementById('closePdfBtn');
    if (closePdfBtn) closePdfBtn.addEventListener('click', closePdfModal);
    const pdfModal = document.getElementById('pdfModal');
    if (pdfModal) {
      pdfModal.addEventListener('click', (e) => {
        const t = e.target;
        if (t && t.dataset && t.dataset.closePdf === 'true') closePdfModal();
      });
    }

    // Fallback: delegated close handling (works even if modal DOM is injected after scripts)
    document.addEventListener('click', (e) => {
      const target = e.target;
      if (!target) return;

      // Close button
      if (target.closest && target.closest('#closePdfBtn')) {
        closePdfModal();
        return;
      }

      // Click on backdrop
      if (target.dataset && target.dataset.closePdf === 'true') {
        closePdfModal();
        return;
      }
    });



    $('#dupActiveBtn').addEventListener('click', () => duplicateAt(state.active));
    $('#delActiveBtn').addEventListener('click', () => removeAt(state.active));

    $('#catalogBtn').addEventListener('click', openCatalog);
    $('#closeCatalogBtn').addEventListener('click', closeCatalog);
    $('#catalogModal').addEventListener('click', (e) => {
      const t = e.target;
      if (t && t.dataset && t.dataset.close === 'true') closeCatalog();
    });

    window.addEventListener('keydown', (e) => { if (e.key === 'Escape') { closeCatalog(); closePdfModal(); } });

    window.addEventListener('resize', schedulePositionCatalogBtn);
    window.addEventListener('scroll', schedulePositionCatalogBtn, { passive: true });

    // Start
    state.records = [ makeEmptyRecord() ];
    renderAll();
    schedulePositionCatalogBtn();
  </script>

  <!-- PDF modal (排關圖) -->
  <div id="pdfModal" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/40" data-close-pdf="true"></div>
    <div class="absolute inset-0 flex items-center justify-center p-3">
      <div class="w-full max-w-5xl rounded-2xl bg-white shadow-xl overflow-hidden">
        <div class="flex items-center justify-between gap-3 px-4 py-3 border-b">
          <div class="min-w-0">
            <div class="text-sm font-semibold">排關圖</div>
            <div id="pdfTitle" class="text-xs text-slate-500 truncate">—</div>
          </div>
          <button id="closePdfBtn" class="rounded-xl border px-3 py-1.5 text-xs font-semibold hover:bg-slate-50">關閉</button>
        </div>

        <div class="p-3">
          <div id="pdfEmpty" class="hidden rounded-xl border bg-slate-50 p-4 text-sm text-slate-700">
            找不到符合「商品名」的排關圖。請先點「匯入排關圖」上傳 PDF，或確認商品名是否正確。
            <div class="mt-3 text-xs text-slate-500">
              已匯入清單：<span id="pdfListText">（無）</span>
            </div>
          </div>

          <iframe id="pdfFrame" class="hidden w-full h-[75vh] rounded-xl border" title="排關圖 PDF"></iframe>
        </div>
      </div>
    </div>
  </div>

</body>
</html>
