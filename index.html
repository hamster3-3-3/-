<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>å£½å¸é£¯æ„Ÿå®˜è©•æ¸¬ç³»çµ±</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
    body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }

    .score-btn {
      transition: all 0.2s;
      border: 1px solid #e2e8f0;
      background-color: #fff;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      min-height: 4.5rem;
      line-height: 1.4;
    }
    .score-btn.active {
      background-color: #ea580c;
      color: white;
      border-color: #c2410c;
      box-shadow: 0 4px 10px -2px rgba(234, 88, 12, 0.3);
      transform: translateY(-2px);
    }

    .tab-btn {
      padding: 1.25rem 2rem;
      font-weight: 700;
      transition: all 0.3s;
      border-bottom: 4px solid transparent;
      color: #64748b;
    }
    .tab-btn.active {
      color: #ea580c;
      border-bottom-color: #ea580c;
      background-color: white;
    }

    .loader {
      border: 2px solid #f3f3f3;
      border-top: 2px solid #ea580c;
      border-radius: 50%;
      width: 16px;
      height: 16px;
      animation: spin 1s linear infinite;
      display: inline-block;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
  </style>
</head>

<body class="p-4 md:p-8">
  <div class="max-w-5xl mx-auto">
    <!-- é ‚éƒ¨å€å¡Š -->
    <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 flex flex-col md:flex-row justify-between items-center border-t-8 border-orange-600">
      <div class="text-center md:text-left">
        <h1 class="text-3xl font-black text-slate-800 tracking-tight">å£½å¸é£¯æ„Ÿå®˜è©•æ¸¬ç³»çµ±</h1>
        <p class="text-slate-500 mt-2 text-sm">é€å‡ºè³‡æ–™å°‡å¯«å…¥æ‚¨çš„ Google è¡¨å–®ï¼ˆéœ€å¡«å…¥è¡¨å–® entry ä»£ç¢¼ï¼‰</p>
      </div>

      <div class="mt-6 md:mt-0 flex flex-col items-end gap-3 w-full md:w-auto">
        <div class="flex items-center gap-2 w-full">
          <span class="text-slate-600 font-bold whitespace-nowrap">è©•æ¸¬è€…ï¼š</span>
          <input type="text" id="assessorName" placeholder="è«‹è¼¸å…¥å§“å" class="flex-grow md:w-48 border-b-2 border-slate-200 p-2 focus:border-orange-500 outline-none text-right bg-transparent transition-colors" />
        </div>
        <div class="flex gap-2 w-full md:w-auto">
          <button onclick="exportCSV()" class="flex-1 md:flex-none bg-slate-100 text-slate-600 px-4 py-2 rounded-xl font-bold hover:bg-slate-200 transition text-sm">æœ¬åœ° CSV</button>
          <button id="uploadBtn" onclick="submitToGoogleForm()" class="flex-1 md:flex-none bg-orange-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-orange-700 transition shadow-lg text-sm flex items-center justify-center">
            <span id="btnText">é€å‡ºåˆ° Google è¡¨å–®</span>
          </button>
        </div>
      </div>
    </div>

    <!-- é¡åˆ¥åˆ‡æ› -->
    <div class="flex bg-slate-200/50 rounded-t-2xl overflow-hidden p-1 gap-1">
      <button onclick="switchCategory('ç´°å·')" id="tab-ç´°å·" class="tab-btn flex-1 rounded-t-xl active">ç´°å·ç³»åˆ—</button>
      <button onclick="switchCategory('è„†å·')" id="tab-è„†å·" class="tab-btn flex-1 rounded-t-xl">è„†å·ç³»åˆ—</button>
      <button onclick="switchCategory('æ‰‹å·')" id="tab-æ‰‹å·" class="tab-btn flex-1 rounded-t-xl">æ‰‹å·ç³»åˆ—</button>
    </div>

    <!-- ä¸»é«”å…§å®¹ -->
    <div class="bg-white rounded-b-2xl shadow-xl border border-slate-200 overflow-hidden min-h-[600px]">
      <div class="bg-orange-50 p-6 border-b border-orange-100 flex flex-col sm:flex-row items-center gap-4 justify-center">
        <label class="text-orange-900 font-bold text-xl">ç›®å‰è©•æ¸¬æ¨£å“ï¼š</label>
        <select id="idSelector" onchange="switchId(this.value)" class="bg-white border-2 border-orange-300 rounded-2xl px-8 py-3 font-black text-2xl text-orange-700 outline-none focus:ring-4 focus:ring-orange-500/20 w-full sm:w-72 cursor-pointer shadow-sm text-center"></select>
      </div>

      <div id="formContent" class="p-6 md:p-10"></div>
    </div>

    <div id="msgBox" class="fixed bottom-8 left-1/2 -translate-x-1/2 px-8 py-4 rounded-2xl shadow-2xl transition-all duration-300 opacity-0 pointer-events-none z-50 font-bold"></div>
  </div>

  <!-- ç”¨ä¾†é¿å…è·³è½‰é é¢ï¼šä»¥ hidden iframe æ¥æ”¶ Google Form çš„å›æ‡‰ -->
  <iframe name="hidden_iframe" style="display:none;"></iframe>

  <script>
    /**********************************************************************
     * 1) è«‹åœ¨æ­¤å¡«å…¥æ‚¨çš„ Google è¡¨å–®è³‡è¨Š
     *
     * Google Form é€å‡ºç«¯é»é€šå¸¸ç‚ºï¼š
     *   https://docs.google.com/forms/d/e/<FORM_ID>/formResponse
     *
     * entry id å–å¾—æ–¹å¼ï¼ˆå»ºè­°ï¼‰ï¼š
     * - æ‰“é–‹æ‚¨çš„ Google è¡¨å–® â†’ å³ä¸Šè§’ã€Œæ›´å¤šï¼ˆâ‹®ï¼‰ã€â†’ å–å¾—é å¡«é€£çµ
     * - å°æ¯å€‹é¡Œç›®å…ˆå¡«ä»»æ„å€¼ï¼Œç”¢ç”Ÿé å¡«é€£çµ
     * - URL ä¸­æœƒå‡ºç¾ entry.123456=xxx çš„åƒæ•¸ï¼Œé€™å€‹ 123456 å°±æ˜¯è©²é¡Œç›®çš„ entry id
     **********************************************************************/

    const GOOGLE_FORM = {
      // å·²ä¾ä½ çš„è¡¨å–® ID è¨­å®šç‚º formResponseï¼ˆé€å‡ºç«¯é»ï¼‰
      actionUrl: 'https://docs.google.com/forms/d/e/1FAIpQLSfT54fOmpPqrv4pcJnje9IVhJQjVvPIlnL9m6D8CmSUxx7zow/formResponse',

      /**
       * ä¾ä½ æä¾›çš„ã€Œé å¡«é€£çµã€å¯è¾¨è­˜åˆ° 3 å€‹é¡Œç›®çš„ entry idï¼š
       * entry.2000108856ã€entry.1397242898ã€entry.243758096
       *
       * ç”±æ–¼ç›®å‰åªå–å¾— 3 å€‹ entryï¼Œé€™è£¡å…ˆå‡è¨­å®ƒå€‘å°æ‡‰åˆ°ï¼šå¤–è§€/å£æ„Ÿ/è€åŒ–ï¼ˆä¸‰å€‹é¸é …é¡Œï¼‰ã€‚
       * è‹¥ä½ ä¹‹å¾Œå†æä¾›ã€ŒåŒ…å«å…¶ä»–é¡Œç›®ã€çš„é å¡«é€£çµï¼Œæˆ‘å¯ä»¥å†æŠŠï¼šè©•æ¸¬è€…ã€é¡åˆ¥ã€æ¨£å“ç·¨è™Ÿã€ç¸½åˆ†ã€è©•èªç­‰ entry ä¸€æ¬¡è£œé½Šã€‚
       */
      entries: {
        // ä¾ä½ æœ€æ–°ã€Œå®Œæ•´é å¡«é€£çµã€æ¨å®šçš„æ¬„ä½å°æ‡‰ï¼ˆä¾ URL åƒæ•¸å‡ºç¾é †åºï¼‰
        // Q1 æ–‡å­—ï¼šè©•æ¸¬è€…
        assessorName: 'entry.36672854',
        // Q2 é¸å–®/å–®é¸ï¼šå“é¡ï¼ˆç´°å·/è„†å·/æ‰‹å·ï¼‰
        category: 'entry.332771533',
        // Q3 æ–‡å­—ï¼šæ¨£å“ç·¨è™Ÿ
        sampleId: 'entry.720346920',

        // Q4~Q6ï¼šä¸‰å€‹è©•åˆ†é¡Œ
        scoreApp: 'entry.2000108856',
        scoreTex: 'entry.1397242898',
        scoreSta: 'entry.243758096',

        // Q7ï¼šç¸½åˆ†
        totalScore: 'entry.1626986528',
        // Q8ï¼šè©•èª
        comment: 'entry.215213340'
      }
    };

    /**********************************************************************
     * 2) ç³»çµ±è³‡æ–™èˆ‡ç•«é¢
     **********************************************************************/

    const sampleIds = ['A(D+1)', 'A(D+2)', 'B(D+1)', 'B(D+2)'];
    const categories = ['ç´°å·', 'è„†å·', 'æ‰‹å·'];

    const scoreMapping = {
      appearance: { 1: 0, 2: 10, 3: 20, 4: 10 },
      texture: { 1: 0, 2: 20, 3: 40, 4: 20, 5: 0 },
      staling: { 1: 40, 2: 30, 3: 20, 4: 10 }
    };

    let allData = {};
    categories.forEach(cat => {
      sampleIds.forEach(id => {
        allData[`${cat}_${id}`] = {
          category: cat,
          id: id,
          appearance: null,
          texture: null,
          staling: null,
          comment: ''
        };
      });
    });

    let currentCategory = 'ç´°å·';
    let currentId = 'A(D+1)';

    function switchCategory(cat) {
      currentCategory = cat;
      document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
      document.getElementById(`tab-${cat}`).classList.add('active');
      const selector = document.getElementById('idSelector');
      selector.innerHTML = sampleIds.map(id => `<option value="${id}">${id}</option>`).join('');
      switchId(sampleIds[0]);
    }

    function switchId(id) {
      currentId = id;
      document.getElementById('idSelector').value = id;
      renderForm();
    }

    function renderForm() {
      const container = document.getElementById('formContent');
      const data = allData[`${currentCategory}_${currentId}`];

      container.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
          <div class="lg:col-span-8 space-y-12">
            <section>
              <h3 class="flex items-center gap-4 font-black text-slate-800 mb-6 text-xl">
                <span class="bg-orange-600 text-white w-9 h-9 flex items-center justify-center rounded-xl shadow-md">1</span>
                å¤–è§€æè¿°
              </h3>
              <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                ${renderScoreButtons('appearance', [
                  {v:1, t:'é£¯ç²’ä¸å®Œæ•´ã€å…‰æ¾¤ä¸å‡å‹»'}, {v:2, t:'é£¯ç²’ä¸å®Œæ•´ã€å…‰æ¾¤å‡å‹»'},
                  {v:3, t:'é£¯ç²’å®Œæ•´ã€å…‰æ¾¤å‡å‹»'}, {v:4, t:'é£¯ç²’å®Œæ•´ã€å…‰æ¾¤ä¸å‡å‹»'}
                ])}
              </div>
            </section>

            <section>
              <h3 class="flex items-center gap-4 font-black text-slate-800 mb-6 text-xl">
                <span class="bg-orange-600 text-white w-9 h-9 flex items-center justify-center rounded-xl shadow-md">2</span>
                å£æ„Ÿç¡¬åº¦
              </h3>
              <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
                ${renderScoreButtons('texture', [
                  {v:1, t:'æ¥µç¡¬'}, {v:2, t:'åç¡¬'}, {v:3, t:'è»Ÿç¡¬é©ä¸­'}, {v:4, t:'åè»Ÿçˆ›'}, {v:5, t:'æ¥µè»Ÿçˆ›'}
                ])}
              </div>
            </section>

            <section>
              <h3 class="flex items-center gap-4 font-black text-slate-800 mb-6 text-xl">
                <span class="bg-orange-600 text-white w-9 h-9 flex items-center justify-center rounded-xl shadow-md">3</span>
                è€åŒ–ç¨‹åº¦
              </h3>
              <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                ${renderScoreButtons('staling', [
                  {v:1, t:'å®Œå…¨ç„¡è€åŒ–'}, {v:2, t:'äº›è¨±è€åŒ–'}, {v:3, t:'å¤§éƒ¨åˆ†è€åŒ–'}, {v:4, t:'å®Œå…¨è€åŒ–'}
                ])}
              </div>
            </section>
          </div>

          <div class="lg:col-span-4 space-y-6">
            <div class="bg-slate-50 p-6 rounded-3xl border border-slate-200 shadow-inner h-full flex flex-col">
              <h3 class="font-black text-slate-800 mb-4">ç¶œåˆæ„Ÿå®˜è©•èª</h3>
              <textarea oninput="updateComment(this.value)" class="w-full flex-grow p-5 text-base rounded-2xl border border-slate-300 outline-none focus:ring-4 focus:ring-orange-500/10 bg-white transition-all shadow-sm min-h-[300px]" placeholder="è«‹å¡«å¯«æ„Ÿå—...">${escapeHtml(data.comment)}</textarea>
            </div>
          </div>
        </div>
      `;
    }

    function renderScoreButtons(field, options) {
      const currentVal = allData[`${currentCategory}_${currentId}`][field];
      return options.map(opt => `
        <button onclick="setScore('${field}', ${opt.v})"
                class="score-btn p-3 rounded-2xl text-sm font-bold ${currentVal === opt.v ? 'active' : ''}">
          ${opt.t}
        </button>
      `).join('');
    }

    function setScore(field, val) {
      allData[`${currentCategory}_${currentId}`][field] = val;
      renderForm();
    }

    function updateComment(val) {
      allData[`${currentCategory}_${currentId}`].comment = val;
    }

    function escapeHtml(str) {
      return (str || '')
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;');
    }

    /**********************************************************************
     * 3) é€å‡ºåˆ° Google è¡¨å–®ï¼ˆä¸è·³é ï¼‰
     *
     * æ³¨æ„ï¼šGoogle Form é€å‡ºé€šå¸¸ç„¡æ³•åš CORS æˆåŠŸå›è®€å›æ‡‰å…§å®¹ã€‚
     * é€™è£¡ä½¿ç”¨ã€Œå‹•æ…‹å»ºç«‹ form + hidden iframeã€æ–¹å¼é€å‡ºï¼Œé¿å…è·¨ç¶²åŸŸé™åˆ¶ã€‚
     **********************************************************************/

    function assertFormConfig() {
      // è‡³å°‘è¦æœ‰ actionUrl + ä¸‰å€‹è©•åˆ† entry æ‰èƒ½é€å‡º
      if (!GOOGLE_FORM.actionUrl) return false;
      const e = GOOGLE_FORM.entries || {};
      return Boolean(e.scoreApp && e.scoreTex && e.scoreSta);
    }

    async function submitToGoogleForm() {
      const name = document.getElementById('assessorName').value.trim();
      if (!name) {
        showMessage('âš ï¸ è«‹è¼¸å…¥æ‚¨çš„å§“å', 'error');
        document.getElementById('assessorName').focus();
        return;
      }

      if (!assertFormConfig()) {
        showMessage('âš ï¸ Google è¡¨å–®è¨­å®šä¸è¶³ï¼šç›®å‰è‡³å°‘éœ€è¦ 3 å€‹è©•åˆ†é¡Œçš„ entryï¼ˆå·²å…ˆæ›¿ä½ å¡«å…¥ï¼‰ï¼Œä½†è‹¥ä½ è¡¨å–®çµæ§‹ä¸åŒï¼Œè«‹å†æä¾›å®Œæ•´é å¡«é€£çµä»¥æ ¡æ­£å°æ‡‰ã€‚', 'error');
        return;
      }

      const d = allData[`${currentCategory}_${currentId}`];
      if (!d.appearance || !d.texture || !d.staling) {
        showMessage('âš ï¸ æ­¤æ¨£å“é‚„æœ‰é …ç›®æœªè©•åˆ†', 'error');
        return;
      }

      const btn = document.getElementById('uploadBtn');
      const btnText = document.getElementById('btnText');
      btn.disabled = true;
      btnText.innerHTML = '<span class="loader mr-2"></span>é€å‡ºä¸­';

      const sApp = scoreMapping.appearance[d.appearance];
      const sTex = scoreMapping.texture[d.texture];
      const sSta = scoreMapping.staling[d.staling];
      const total = sApp + sTex + sSta;

      // å‹•æ…‹å»ºç«‹ form ä¸¦é€åˆ° hidden iframeï¼Œé¿å…è·¨ç¶²åŸŸé™åˆ¶
      const form = document.createElement('form');
      form.action = GOOGLE_FORM.actionUrl;
      form.method = 'POST';
      form.target = 'hidden_iframe';

      // åªé€å‡ºæœ‰è¨­å®š entry id çš„æ¬„ä½ï¼ˆæœªå–å¾— entry id çš„æ¬„ä½æœƒè‡ªå‹•ç•¥éï¼‰
      const fields = [];

      // ç›®å‰ä¸‰å€‹è©•åˆ†é¡Œï¼ˆå¿…é€ï¼‰
      fields.push([GOOGLE_FORM.entries.scoreApp, String(sApp)]);
      fields.push([GOOGLE_FORM.entries.scoreTex, String(sTex)]);
      fields.push([GOOGLE_FORM.entries.scoreSta, String(sSta)]);

      // å…¶é¤˜æ¬„ä½ï¼ˆå¯é¸ï¼Œæœ‰ entry id æ‰é€ï¼‰
      if (GOOGLE_FORM.entries.assessorName) fields.push([GOOGLE_FORM.entries.assessorName, name]);
      if (GOOGLE_FORM.entries.category) fields.push([GOOGLE_FORM.entries.category, d.category]);
      if (GOOGLE_FORM.entries.sampleId) fields.push([GOOGLE_FORM.entries.sampleId, d.id]);
      if (GOOGLE_FORM.entries.totalScore) fields.push([GOOGLE_FORM.entries.totalScore, String(total)]);
      if (GOOGLE_FORM.entries.comment) fields.push([GOOGLE_FORM.entries.comment, d.comment || '']);

      fields.forEach(([k, v]) => {
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = k;
        input.value = v;
        form.appendChild(input);
      });

      document.body.appendChild(form);

      try {
        form.submit();
        showMessage(`ğŸš€ [${d.id}] å·²é€å‡ºåˆ° Google è¡¨å–®`, 'success');
      } catch (err) {
        console.error(err);
        showMessage('âŒ é€å‡ºç™¼ç”Ÿç•°å¸¸ï¼Œè«‹é‡è©¦', 'error');
      } finally {
        form.remove();
        btn.disabled = false;
        btnText.innerText = 'é€å‡ºåˆ° Google è¡¨å–®';
      }
    }

    function showMessage(text, type) {
      const msgBox = document.getElementById('msgBox');
      msgBox.innerText = text;
      msgBox.className = `fixed bottom-8 left-1/2 -translate-x-1/2 px-8 py-4 rounded-2xl shadow-2xl transition-all duration-300 z-50 font-bold ${
        type === 'error' ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'
      }`;
      msgBox.style.opacity = '1';
      msgBox.style.transform = 'translateX(-50%) translateY(-10px)';

      setTimeout(() => {
        msgBox.style.opacity = '0';
        msgBox.style.transform = 'translateX(-50%) translateY(0)';
      }, 3000);
    }

    function exportCSV() {
      const name = document.getElementById('assessorName').value || 'æœªå…·å';
      let csv = "\uFEFFåˆ†é¡,æ¨£å“ç·¨è™Ÿ,è©•æ¸¬è€…,å¤–è§€å¾—åˆ†,å£æ„Ÿå¾—åˆ†,è€åŒ–å¾—åˆ†,ç¸½åˆ†,è©•èª\n";
      Object.values(allData).forEach(d => {
        if (d.appearance || d.texture || d.staling || d.comment) {
          csv += `"${d.category}","${d.id}","${name}","${scoreMapping.appearance[d.appearance] || 0}","${scoreMapping.texture[d.texture] || 0}","${scoreMapping.staling[d.staling] || 0}","${(scoreMapping.appearance[d.appearance] || 0) + (scoreMapping.texture[d.texture] || 0) + (scoreMapping.staling[d.staling] || 0)}",` +
                 `"${(d.comment || '').replace(/"/g, '""')}"\n`;
        }
      });
      const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `å£½å¸é£¯è©•æ¸¬_${name}_${new Date().toISOString().slice(0, 10)}.csv`;
      link.click();
    }

    window.onload = () => switchCategory('ç´°å·');
  </script>
</body>
</html>
