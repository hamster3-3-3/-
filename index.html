<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£½å¸é£¯æ„Ÿå®˜è©•æ¸¬ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f1f5f9; }
        
        .score-btn { 
            transition: all 0.2s; 
            border: 1px solid #e2e8f0;
            background-color: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 4.5rem;
            line-height: 1.4;
        }
        .score-btn.active { 
            background-color: #ea580c; 
            color: white; 
            border-color: #c2410c;
            box-shadow: 0 4px 10px -2px rgba(234, 88, 12, 0.3);
            transform: translateY(-2px);
        }
        
        .tab-btn {
            padding: 1.25rem 2rem;
            font-weight: 700;
            transition: all 0.3s;
            border-bottom: 4px solid transparent;
            color: #64748b;
        }
        .tab-btn.active {
            color: #ea580c;
            border-bottom-color: #ea580c;
            background-color: white;
        }

        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #ea580c;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
            display: inline-block;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-5xl mx-auto">
        <!-- é ‚éƒ¨å€å¡Š -->
        <div class="bg-white p-6 rounded-2xl shadow-sm mb-6 flex flex-col md:flex-row justify-between items-center border-t-8 border-orange-600">
            <div class="text-center md:text-left">
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">å£½å¸é£¯æ„Ÿå®˜è©•æ¸¬ç³»çµ±</h1>
            </div>
            
            <div class="mt-6 md:mt-0 flex flex-col items-end gap-3 w-full md:w-auto">
                <div class="flex items-center gap-2 w-full">
                    <span class="text-slate-600 font-bold whitespace-nowrap">è©•æ¸¬è€…ï¼š</span>
                    <input type="text" id="assessorName" placeholder="è«‹è¼¸å…¥å§“å" class="flex-grow md:w-48 border-b-2 border-slate-200 p-2 focus:border-orange-500 outline-none text-right bg-transparent transition-colors">
                </div>
                <div class="flex gap-2 w-full md:w-auto">
                    <button onclick="exportCSV()" class="flex-1 md:flex-none bg-slate-100 text-slate-600 px-4 py-2 rounded-xl font-bold hover:bg-slate-200 transition text-sm">
                        æœ¬åœ° CSV
                    </button>
                    <button id="uploadBtn" onclick="uploadToCloud()" class="flex-1 md:flex-none bg-orange-600 text-white px-6 py-2 rounded-xl font-bold hover:bg-orange-700 transition shadow-lg text-sm flex items-center justify-center">
                        <span id="btnText">ä¸Šå‚³è‡³é›²ç«¯</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- é¡åˆ¥åˆ‡æ› -->
        <div class="flex bg-slate-200/50 rounded-t-2xl overflow-hidden p-1 gap-1">
            <button onclick="switchCategory('ç´°å·')" id="tab-ç´°å·" class="tab-btn flex-1 rounded-t-xl active">ç´°å·ç³»åˆ—</button>
            <button onclick="switchCategory('è„†å·')" id="tab-è„†å·" class="tab-btn flex-1 rounded-t-xl">è„†å·ç³»åˆ—</button>
            <button onclick="switchCategory('æ‰‹å·')" id="tab-æ‰‹å·" class="tab-btn flex-1 rounded-t-xl">æ‰‹å·ç³»åˆ—</button>
        </div>

        <!-- ä¸»é«”å…§å®¹ -->
        <div class="bg-white rounded-b-2xl shadow-xl border border-slate-200 overflow-hidden min-h-[600px]">
            <div class="bg-orange-50 p-6 border-b border-orange-100 flex flex-col sm:flex-row items-center gap-4 justify-center">
                <label class="text-orange-900 font-bold text-xl">ç›®å‰è©•æ¸¬æ¨£å“ï¼š</label>
                <select id="idSelector" onchange="switchId(this.value)" class="bg-white border-2 border-orange-300 rounded-2xl px-8 py-3 font-black text-2xl text-orange-700 outline-none focus:ring-4 focus:ring-orange-500/20 w-full sm:w-72 cursor-pointer shadow-sm text-center">
                </select>
            </div>

            <div id="formContent" class="p-6 md:p-10">
            </div>
        </div>
        
        <div id="msgBox" class="fixed bottom-8 left-1/2 -translate-x-1/2 px-8 py-4 rounded-2xl shadow-2xl transition-all duration-300 opacity-0 pointer-events-none z-50 font-bold"></div>
    </div>

    <script>
        /**
         * ç³»çµ±è¨­å®šï¼šå·²å¡«å…¥æ‚¨æä¾›çš„éƒ¨ç½²ç¶²å€
         */
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbz4TVvzo9RyGrNZnXd-xHWAJNUd6028JAv8zYCJzwVRnUOeR-YYKEyYRvNuBLqIerh_/exec';
        
        const sampleIds = ['A(D+1)', 'A(D+2)', 'B(D+1)', 'B(D+2)'];
        const categories = ['ç´°å·', 'è„†å·', 'æ‰‹å·'];
        
        const scoreMapping = {
            appearance: { 1: 0, 2: 10, 3: 20, 4: 10 },
            texture: { 1: 0, 2: 20, 3: 40, 4: 20, 5: 0 },
            staling: { 1: 40, 2: 30, 3: 20, 4: 10 }
        };

        let allData = {};
        categories.forEach(cat => {
            sampleIds.forEach(id => {
                allData[`${cat}_${id}`] = {
                    category: cat, id: id, appearance: null, texture: null, staling: null, comment: ''
                };
            });
        });

        let currentCategory = 'ç´°å·';
        let currentId = 'A(D+1)';

        function switchCategory(cat) {
            currentCategory = cat;
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${cat}`).classList.add('active');
            const selector = document.getElementById('idSelector');
            selector.innerHTML = sampleIds.map(id => `<option value="${id}">${id}</option>`).join('');
            switchId(sampleIds[0]);
        }

        function switchId(id) {
            currentId = id;
            document.getElementById('idSelector').value = id;
            renderForm();
        }

        function renderForm() {
            const container = document.getElementById('formContent');
            const data = allData[`${currentCategory}_${currentId}`];
            
            container.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-12 gap-10">
                    <div class="lg:col-span-8 space-y-12">
                        <section>
                            <h3 class="flex items-center gap-4 font-black text-slate-800 mb-6 text-xl">
                                <span class="bg-orange-600 text-white w-9 h-9 flex items-center justify-center rounded-xl shadow-md">1</span>
                                å¤–è§€æè¿°
                            </h3>
                            <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                ${renderScoreButtons('appearance', [
                                    {v:1, t:'é£¯ç²’ä¸å®Œæ•´ã€å…‰æ¾¤ä¸å‡å‹»'}, {v:2, t:'é£¯ç²’ä¸å®Œæ•´ã€å…‰æ¾¤å‡å‹»'}, 
                                    {v:3, t:'é£¯ç²’å®Œæ•´ã€å…‰æ¾¤å‡å‹»'}, {v:4, t:'é£¯ç²’å®Œæ•´ã€å…‰æ¾¤ä¸å‡å‹»'}
                                ])}
                            </div>
                        </section>

                        <section>
                            <h3 class="flex items-center gap-4 font-black text-slate-800 mb-6 text-xl">
                                <span class="bg-orange-600 text-white w-9 h-9 flex items-center justify-center rounded-xl shadow-md">2</span>
                                å£æ„Ÿç¡¬åº¦
                            </h3>
                            <div class="grid grid-cols-2 sm:grid-cols-5 gap-3">
                                ${renderScoreButtons('texture', [
                                    {v:1, t:'æ¥µç¡¬'}, {v:2, t:'åç¡¬'}, {v:3, t:'è»Ÿç¡¬é©ä¸­'}, {v:4, t:'åè»Ÿçˆ›'}, {v:5, t:'æ¥µè»Ÿçˆ›'}
                                ])}
                            </div>
                        </section>

                        <section>
                            <h3 class="flex items-center gap-4 font-black text-slate-800 mb-6 text-xl">
                                <span class="bg-orange-600 text-white w-9 h-9 flex items-center justify-center rounded-xl shadow-md">3</span>
                                è€åŒ–ç¨‹åº¦
                            </h3>
                            <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                                ${renderScoreButtons('staling', [
                                    {v:1, t:'å®Œå…¨ç„¡è€åŒ–'}, {v:2, t:'äº›è¨±è€åŒ–'}, {v:3, t:'å¤§éƒ¨åˆ†è€åŒ–'}, {v:4, t:'å®Œå…¨è€åŒ–'}
                                ])}
                            </div>
                        </section>
                    </div>

                    <div class="lg:col-span-4 space-y-6">
                        <div class="bg-slate-50 p-6 rounded-3xl border border-slate-200 shadow-inner h-full flex flex-col">
                            <h3 class="font-black text-slate-800 mb-4">ç¶œåˆæ„Ÿå®˜è©•èª</h3>
                            <textarea oninput="updateComment(this.value)" class="w-full flex-grow p-5 text-base rounded-2xl border border-slate-300 outline-none focus:ring-4 focus:ring-orange-500/10 bg-white transition-all shadow-sm min-h-[300px]" placeholder="è«‹å¡«å¯«æ„Ÿå—...">${data.comment}</textarea>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderScoreButtons(field, options) {
            const currentVal = allData[`${currentCategory}_${currentId}`][field];
            return options.map(opt => `
                <button onclick="setScore('${field}', ${opt.v})" 
                        class="score-btn p-3 rounded-2xl text-sm font-bold ${currentVal === opt.v ? 'active' : ''}">
                    ${opt.t}
                </button>
            `).join('');
        }

        function setScore(field, val) {
            allData[`${currentCategory}_${currentId}`][field] = val;
            renderForm();
        }

        function updateComment(val) {
            allData[`${currentCategory}_${currentId}`].comment = val;
        }

        /**
         * é›²ç«¯ä¸Šå‚³é‚è¼¯
         */
        async function uploadToCloud() {
            const name = document.getElementById('assessorName').value.trim();
            if (!name) { 
                showMessage('âš ï¸ è«‹è¼¸å…¥æ‚¨çš„å§“å', 'error'); 
                document.getElementById('assessorName').focus();
                return; 
            }

            const d = allData[`${currentCategory}_${currentId}`];
            if (!d.appearance || !d.texture || !d.staling) {
                showMessage('âš ï¸ æ­¤æ¨£å“é‚„æœ‰é …ç›®æœªè©•åˆ†', 'error');
                return;
            }

            const btn = document.getElementById('uploadBtn');
            const btnText = document.getElementById('btnText');
            btn.disabled = true;
            btnText.innerHTML = '<span class="loader mr-2"></span>ä¸Šå‚³ä¸­';

            const sApp = scoreMapping.appearance[d.appearance];
            const sTex = scoreMapping.texture[d.texture];
            const sSta = scoreMapping.staling[d.staling];

            const formData = new URLSearchParams();
            formData.append('assessorName', name);
            formData.append('category', d.category);
            formData.append('sampleId', d.id);
            formData.append('scoreApp', sApp);
            formData.append('scoreTex', sTex);
            formData.append('scoreSta', sSta);
            formData.append('totalScore', sApp + sTex + sSta);
            formData.append('comment', d.comment);

            try {
                // ä½¿ç”¨ no-cors æ¨¡å¼ç™¼é€ POSTï¼Œä»¥é¿é–‹è·¨ç¶²åŸŸé™åˆ¶ï¼ˆGoogle Script å¸¸ç”¨åšæ³•ï¼‰
                await fetch(SCRIPT_URL, { 
                    method: 'POST', 
                    mode: 'no-cors', 
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: formData 
                });
                
                showMessage(`ğŸš€ [${d.id}] æ•¸æ“šå·²ç™¼é€è‡³é›²ç«¯`, 'success');
            } catch (err) {
                console.error(err);
                showMessage('âŒ ä¸Šå‚³ç™¼ç”Ÿç•°å¸¸ï¼Œè«‹é‡è©¦', 'error');
            } finally {
                btn.disabled = false;
                btnText.innerText = 'ä¸Šå‚³è‡³é›²ç«¯';
            }
        }

        function showMessage(text, type) {
            const msgBox = document.getElementById('msgBox');
            msgBox.innerText = text;
            msgBox.className = `fixed bottom-8 left-1/2 -translate-x-1/2 px-8 py-4 rounded-2xl shadow-2xl transition-all duration-300 z-50 font-bold ${
                type === 'error' ? 'bg-red-600 text-white' : 'bg-slate-800 text-white'
            }`;
            msgBox.style.opacity = "1";
            msgBox.style.transform = "translateX(-50%) translateY(-10px)";
            
            setTimeout(() => {
                msgBox.style.opacity = "0";
                msgBox.style.transform = "translateX(-50%) translateY(0)";
            }, 3000);
        }

        function exportCSV() {
            const name = document.getElementById('assessorName').value || 'æœªå…·å';
            let csv = "\uFEFFåˆ†é¡,æ¨£å“ç·¨è™Ÿ,è©•æ¸¬è€…,å¤–è§€å¾—åˆ†,å£æ„Ÿå¾—åˆ†,è€åŒ–å¾—åˆ†,ç¸½åˆ†,è©•èª\n";
            Object.values(allData).forEach(d => {
                if(d.appearance || d.texture || d.staling || d.comment) {
                    csv += `"${d.category}","${d.id}","${name}","${scoreMapping.appearance[d.appearance]||0}","${scoreMapping.texture[d.texture]||0}","${scoreMapping.staling[d.staling]||0}","${(scoreMapping.appearance[d.appearance]||0)+(scoreMapping.texture[d.texture]||0)+(scoreMapping.staling[d.staling]||0)}","${d.comment.replace(/"/g, '""')}"\n`;
                }
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `å£½å¸é£¯è©•æ¸¬_${name}_${new Date().toISOString().slice(0,10)}.csv`;
            link.click();
        }

        window.onload = () => switchCategory('ç´°å·');
    </script>
</body>
</html>
